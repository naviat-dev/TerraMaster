name: Cleanup old artifacts

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const keep = 21;

            const { data } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const oldArtifacts = data.artifacts
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(keep);

            for (const artifact of oldArtifacts) {
              core.info(`Deleting artifact: ${artifact.name} (${artifact.id})`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
